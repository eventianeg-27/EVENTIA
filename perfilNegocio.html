<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <title>Perfil del Negocio</title>
  <link rel="stylesheet" href="perfilNegocio.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getFirestore, doc, getDoc, collection, getDocs, collectionGroup } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

    // âœ… ConfiguraciÃ³n Firebase (usa la misma que en principal)
    const firebaseConfig = {
      apiKey: "AIzaSyBhX59jBh2tUkEnEGcb9sFVyW2zJe9NB_w",
      authDomain: "eventia-9ead3.firebaseapp.com",
      projectId: "eventia-9ead3",
      storageBucket: "eventia-9ead3.appspot.com",
      messagingSenderId: "313661648136",
      appId: "1:313661648136:web:1c9eb73bbb3f78994c90bd",
      measurementId: "G-RDLNL394MH"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const div = document.getElementById("contenidoProveedor");

    // âœ… Ahora usamos el objeto usuarioLogueado
    const usuarioLogueado = JSON.parse(localStorage.getItem("usuarioLogueado") || "{}");
    const usuario = (usuarioLogueado.correo || "").trim();
    const negocioId = (localStorage.getItem("negocioId") || "").trim();

    if (!usuario || !negocioId) {
      div.innerHTML = "<p>Faltan datos para mostrar el perfil del negocio.</p>";
    } else {
      const negocioRef = doc(db, "usuarios", usuario, "negocios", negocioId);


      // ðŸ”§ Convertir hora 24h â†’ AM/PM
      function convertirHora(hora24) {
        if (!hora24 || typeof hora24 !== "string") return "No disponible";

        const partes = hora24.split(":");
        if (partes.length !== 2) return hora24;

        let h = parseInt(partes[0], 10);
        let m = partes[1];

        if (isNaN(h)) return hora24;

        const sufijo = h >= 12 ? "PM" : "AM";
        let h12 = (h % 12) || 12;

        return `${h12}:${m.padStart(2, "0")} ${sufijo}`;
      }


      // ðŸ”¥ Ver si hoy estÃ¡ abierto y si estÃ¡ dentro del horario
      function estaAbiertoHoy(diasAbierto) {
        const diasSemana = [
          "Domingo", "Lunes", "Martes", "MiÃ©rcoles",
          "Jueves", "Viernes", "SÃ¡bado"
        ];

        const hoy = diasSemana[new Date().getDay()];
        return diasAbierto?.includes(hoy);
      }

      // ðŸ”¥ Convertir "21:00" a minutos para comparar
      function aMinutos(hora) {
        const [h, m] = hora.split(":").map(Number);
        return h * 60 + m;
      }

      // ðŸ”¥ Saber si estÃ¡ dentro del horario actual
      function estaEnHorario(horaApertura, horaCierre) {
        if (!horaApertura || !horaCierre) return false;

        const ahora = new Date();
        const minutosActual = ahora.getHours() * 60 + ahora.getMinutes();

        const apertura = aMinutos(horaApertura);
        const cierre = aMinutos(horaCierre);

        // Caso normal (ej: 9 AM â†’ 7 PM)
        if (apertura < cierre) {
          return minutosActual >= apertura && minutosActual <= cierre;
        }

        // Caso cruzando medianoche (ej: 9 PM â†’ 3 AM)
        return minutosActual >= apertura || minutosActual <= cierre;
      }

      // ðŸ”¥ Genera badge visual
      function generarEstadoAbierto(datos) {
        if (!Array.isArray(datos.diasAbierto)) return "";

        const abiertoHoy = estaAbiertoHoy(datos.diasAbierto);
        const enHorario = estaEnHorario(datos.horaApertura, datos.horaCierre);

        if (abiertoHoy && enHorario) {
          return `
      <span class="badge bg-success px-3 py-2" style="font-size:15px;">
        ðŸŸ¢ Abierto ahora
      </span>`;
        }

        return `
    <span class="badge bg-danger px-3 py-2" style="font-size:15px;">
      ðŸ”´ Cerrado
    </span>`;
      }



      getDoc(negocioRef).then(docSnap => {
        if (!docSnap.exists()) {
          div.innerHTML = "<p>No se encontrÃ³ el negocio.</p>";
        } else {
          const datos = docSnap.data();

          const redesHTML = Array.isArray(datos.redesSociales)
            ? datos.redesSociales.map(red => {
              const enlace = datos.usuariosRedes?.[red] || "";
              return enlace
                ? `<li><strong>${red}:</strong> <a href="${enlace}" target="_blank">${enlace}</a></li>`
                : `<li><strong>${red}</strong></li>`;
            }).join("")
            : "";

          const galeriaHTML = Array.isArray(datos.evidencias)
            ? datos.evidencias.map(url => `
              <div class="col-md-4 mb-3">
                ${url.match(/\.(mp4|webm|ogg)$/i)
                ? `<video src="${url}" controls style="width: 100%; border-radius: 8px;"></video>`
                : `<img src="${url}" class="img-fluid rounded" style="border-radius: 8px;" />`}
              </div>`).join("")
            : "";

          div.innerHTML = `
            <div class="d-flex align-items-center mb-4">
              <img src="${datos.urlImagen || 'default.jpg'}" alt="Foto de perfil" class="rounded-circle me-3" style="width: 100px; height: 100px; object-fit: cover;" />
              <h4 class="mb-0">${datos.negocio || 'Negocio sin nombre'}</h4>
            </div>
            <p><strong>TelÃ©fono:</strong> ${datos.telefono || 'No disponible'}</p>
            <p><strong>UbicaciÃ³n:</strong> 
              ${datos.ubicacionLink
              ? `<a href="${datos.ubicacionLink}" target="_blank">${datos.ubicacion}</a>`
              : (datos.ubicacion || 'No disponible')}
            </p>

            <!-- Referencia de ubicaciÃ³n -->
            ${datos.referenciaUbicacion
              ? `<p><strong>Referencia de ubicaciÃ³n:</strong> ${datos.referenciaUbicacion}</p>`
              : ''}

            <!-- Imagen de la fachada -->
            ${datos.urlFachada
              ? `<div class="mt-3 fachada-negocio">
              <h5 class="text-primary"><i class="fas fa-store me-2"></i>Fachada del negocio</h5>
              <img src="${datos.urlFachada}" alt="Fachada del negocio" 
                   class="img-fluid rounded shadow-sm" 
                   style="max-width: 400px; border-radius: 10px;"/>
             </div>`
              : ''}

            <p><strong>Especialidad:</strong> ${datos.especialidad || 'No disponible'}</p>
            <p><strong>DescripciÃ³n:</strong> ${datos.descripcion || 'No disponible'}</p>
            
            <!-- DÃ­as y Horario -->
<div class="mt-4">
  <h5 class="text-primary">
    <i class="fas fa-calendar-week me-2"></i>Disponibilidad
   </h5>

  <!-- Estado actual (Abierto o Cerrado) -->
  <p>
    <strong>Estado:</strong>
    ${(() => {
              if (!datos.horaApertura || !datos.horaCierre || !datos.diasAbierto) {
                return `<span class="text-muted">No disponible</span>`;
              }

              const ahora = new Date();
              const diaSemana = [
                "Domingo", "Lunes", "Martes", "MiÃ©rcoles", "Jueves", "Viernes", "SÃ¡bado"
              ][ahora.getDay()];

              // Si hoy no abre
              if (!datos.diasAbierto.includes(diaSemana)) {
                return `<span style="color: red; font-weight: bold;">ðŸ”´ Cerrado</span>`;
              }

              // Obtener hora actual en formato HH:MM
              const horaActual = ahora.getHours() * 60 + ahora.getMinutes();

              const [hA, mA] = datos.horaApertura.split(":").map(n => parseInt(n));
              const [hC, mC] = datos.horaCierre.split(":").map(n => parseInt(n));

              const aperturaMin = hA * 60 + mA;
              const cierreMin = hC * 60 + mC;

              // ValidaciÃ³n de estado
              const abierto = horaActual >= aperturaMin && horaActual <= cierreMin;

              return abierto
                ? `<span style="color: green; font-weight: bold;">ðŸŸ¢ Abierto ahora</span>`
                : `<span style="color: red; font-weight: bold;">ðŸ”´ Cerrado</span>`;
            })()}
  </p>

  <!-- DÃ­as con insignias -->
  <p><strong>DÃ­as abiertos:</strong></p>
  <div class="d-flex flex-wrap gap-2 mb-3">
    ${Array.isArray(datos.diasAbierto)
              ? datos.diasAbierto.map(dia => `
          <span class="badge bg-primary px-3 py-2 d-flex align-items-center" style="font-size: 14px;">
            <i class="fa-solid fa-calendar-day me-2"></i> ${dia}
          </span>
        `).join("")
              : `<span class="text-muted">No disponible</span>`
            }
  </div>

  <!-- Horario (barra verde bonita) -->
  <p><strong>Horario:</strong></p>
  <div class="ms-2">
    ${datos.horaApertura && datos.horaCierre
              ? `
        <span class="badge bg-success px-3 py-2" style="font-size: 15px;">
          <i class="fas fa-clock me-2"></i>
          ${convertirHora(datos.horaApertura)} â€” ${convertirHora(datos.horaCierre)}
        </span>
      `
              : `<span class="text-muted">No disponible</span>`
            }
  </div>
</div>


            <br> <p><strong>Monto Inicial:</strong> $${datos.montoInicial || '0'}</p>
            
            <h5>Redes Sociales:</h5>
            <ul>${redesHTML}</ul>

            <h5 class="mt-4">GalerÃ­a:</h5>
            <div class="row mt-3">
              ${galeriaHTML}
            </div>
          `;
        }
      }).catch(error => {
        console.error("Error al obtener el negocio:", error);
        div.innerHTML = "<p>OcurriÃ³ un error al cargar el perfil.</p>";
      });
    }

    // FunciÃ³n para editar
    window.editarDatos = async function () {
      if (!usuario || !negocioId) return;
      const negocioRef = doc(db, "usuarios", usuario, "negocios", negocioId);
      const docSnap = await getDoc(negocioRef);

      if (docSnap.exists()) {
        const datos = docSnap.data();
        localStorage.setItem("datosProveedor", JSON.stringify(datos));
        localStorage.setItem("modoEdicion", "true");
        localStorage.setItem("negocioId", negocioId);
        window.location.href = "editarNegocio.html";
      }
    };
  </script>
</head>

<body>

  <div class="container py-5">

    <div id="contenidoProveedor" class="mt-2"></div>


    <div class="d-flex justify-content-end mb-3 gap-2">
      <button class="btn btn-secondary" onclick="window.location.href='misNegocios.html'">Regresar</button>
      <button class="btn btn-primary" onclick="editarDatos()">Editar Perfil</button>
    </div>
  </div>
</body>

</html>