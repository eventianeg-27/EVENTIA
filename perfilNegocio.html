<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <title>Perfil del Negocio</title>
  <link rel="stylesheet" href="perfilNegocio.css" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getFirestore, doc, getDoc, collection, getDocs, collectionGroup } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

    // ✅ Configuración Firebase (usa la misma que en principal)
    const firebaseConfig = {
      apiKey: "AIzaSyBhX59jBh2tUkEnEGcb9sFVyW2zJe9NB_w",
      authDomain: "eventia-9ead3.firebaseapp.com",
      projectId: "eventia-9ead3",
      storageBucket: "eventia-9ead3.appspot.com",
      messagingSenderId: "313661648136",
      appId: "1:313661648136:web:1c9eb73bbb3f78994c90bd",
      measurementId: "G-RDLNL394MH"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const div = document.getElementById("contenidoProveedor");

    // ✅ Ahora usamos el objeto usuarioLogueado
    const usuarioLogueado = JSON.parse(localStorage.getItem("usuarioLogueado") || "{}");
    const usuario = (usuarioLogueado.correo || "").trim();
    const negocioId = (localStorage.getItem("negocioId") || "").trim();

    if (!usuario || !negocioId) {
      div.innerHTML = "<p>Faltan datos para mostrar el perfil del negocio.</p>";
    } else {
      const negocioRef = doc(db, "usuarios", usuario, "negocios", negocioId);

      getDoc(negocioRef).then(docSnap => {
        if (!docSnap.exists()) {
          div.innerHTML = "<p>No se encontró el negocio.</p>";
        } else {
          const datos = docSnap.data();

          const redesHTML = Array.isArray(datos.redesSociales)
            ? datos.redesSociales.map(red => {
              const enlace = datos.usuariosRedes?.[red] || "";
              return enlace
                ? `<li><strong>${red}:</strong> <a href="${enlace}" target="_blank">${enlace}</a></li>`
                : `<li><strong>${red}</strong></li>`;
            }).join("")
            : "";

          const galeriaHTML = Array.isArray(datos.evidencias)
            ? datos.evidencias.map(url => `
              <div class="col-md-4 mb-3">
                ${url.match(/\.(mp4|webm|ogg)$/i)
                ? `<video src="${url}" controls style="width: 100%; border-radius: 8px;"></video>`
                : `<img src="${url}" class="img-fluid rounded" style="border-radius: 8px;" />`}
              </div>`).join("")
            : "";

          div.innerHTML = `
            <div class="d-flex align-items-center mb-4">
              <img src="${datos.urlImagen || 'default.jpg'}" alt="Foto de perfil" class="rounded-circle me-3" style="width: 100px; height: 100px; object-fit: cover;" />
              <h4 class="mb-0">${datos.negocio || 'Negocio sin nombre'}</h4>
            </div>
            <p><strong>Teléfono:</strong> ${datos.telefono || 'No disponible'}</p>
            <p><strong>Ubicación:</strong> 
              ${datos.ubicacionLink
              ? `<a href="${datos.ubicacionLink}" target="_blank">${datos.ubicacion}</a>`
              : (datos.ubicacion || 'No disponible')}
            </p>

            <!-- Referencia de ubicación -->
            ${datos.referenciaUbicacion
              ? `<p><strong>Referencia de ubicación:</strong> ${datos.referenciaUbicacion}</p>`
              : ''}

            <!-- Imagen de la fachada -->
            ${datos.urlFachada
              ? `<div class="mt-3 fachada-negocio">
              <h5 class="text-primary"><i class="fas fa-store me-2"></i>Fachada del negocio</h5>
              <img src="${datos.urlFachada}" alt="Fachada del negocio" 
                   class="img-fluid rounded shadow-sm" 
                   style="max-width: 400px; border-radius: 10px;"/>
             </div>`
          : ''}

            <p><strong>Especialidad:</strong> ${datos.especialidad || 'No disponible'}</p>
            <p><strong>Descripción:</strong> ${datos.descripcion || 'No disponible'}</p>
            <p><strong>Horario:</strong> ${datos.horario || 'No disponible'}</p>
            <p><strong>Monto Inicial:</strong> $${datos.montoInicial || '0'}</p>
            
            <h5>Redes Sociales:</h5>
            <ul>${redesHTML}</ul>

            <h5 class="mt-4">Galería:</h5>
            <div class="row mt-3">
              ${galeriaHTML}
            </div>
          `;
        }
      }).catch(error => {
        console.error("Error al obtener el negocio:", error);
        div.innerHTML = "<p>Ocurrió un error al cargar el perfil.</p>";
      });
    }

    // Función para editar
    window.editarDatos = async function () {
      if (!usuario || !negocioId) return;
      const negocioRef = doc(db, "usuarios", usuario, "negocios", negocioId);
      const docSnap = await getDoc(negocioRef);

      if (docSnap.exists()) {
        const datos = docSnap.data();
        localStorage.setItem("datosProveedor", JSON.stringify(datos));
        localStorage.setItem("modoEdicion", "true");
        localStorage.setItem("negocioId", negocioId);
        window.location.href = "editarNegocio.html";
      }
    };
  </script>
</head>

<body>

  <div class="container py-5">
    
    <div id="contenidoProveedor" class="mt-2"></div>


    <div class="d-flex justify-content-end mb-3 gap-2">
      <button class="btn btn-secondary" onclick="window.location.href='misNegocios.html'">Regresar</button>
      <button class="btn btn-primary" onclick="editarDatos()">Editar Perfil</button>
    </div>
  </div>
</body>

</html>