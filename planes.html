<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Planes - Eventia</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />

  <!-- Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">

  <link rel="stylesheet" href="planes.css" />
</head>

<body>
  <div class="planes-container">
    <div class="titulo">PLANES</div>
    <h5 class="mt-4">Seleccione el plan de su elecci√≥n</h5>

    <div class="planes-box">

      <!-- PLAN B√ÅSICO -->
      <div class="plan-card basico">
        <i class="bi bi-stars icon-plan"></i>
        <h3>Plan B√°sico ‚Äì Gratis</h3>
        <p>‚úî Registrar <strong>1 negocio</strong></p>
        <p>‚úî Hasta <strong>1 servicio</strong></p>
        <p>‚úî Visibilidad est√°ndar</p>
        <div class="btn-seleccionar" onclick="elegirPlan('basico')">SELECCIONAR</div>
      </div>

      <!-- PLAN PLUS -->
      <div class="plan-card plus">
        <i class="bi bi-rocket-takeoff icon-plan"></i>
        <h3>Plan Plus</h3>
        <p>‚úî Registrar <strong>2 negocios</strong></p>
        <p>‚úî Hasta <strong>3 servicios</strong></p>
        <p>‚úî Visibilidad est√°ndar</p>
        <div class="btn-seleccionar" onclick="elegirPlan('plus')">SELECCIONAR</div>
      </div>

      <!-- PLAN PREMIUM -->
      <div class="plan-card premium">
        <i class="bi bi-award-fill icon-plan"></i>
        <h3>Plan Premium</h3>
        <p>‚úî Registrar <strong>3 negocios</strong></p>
        <p>‚úî Hasta <strong>5 servicios</strong></p>
        <p>‚úî Aparici√≥n en <strong>carrusel principal</strong></p>
        <div class="btn-seleccionar" onclick="elegirPlan('premium')">SELECCIONAR</div>
      </div>

    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import {
      getFirestore, doc, updateDoc, setDoc, collection, getDocs

    } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

    // üî• CONFIG FIREBASE
    const firebaseConfig = {
      apiKey: "AIzaSyBhX59jBh2tUkEnEGcb9sFVyW2zJe9NB_w",
      authDomain: "eventia-9ead3.firebaseapp.com",
      projectId: "eventia-9ead3",
      storageBucket: "eventia-9ead3.appspot.com",
      messagingSenderId: "313661648136",
      appId: "1:313661648136:web:1c9eb73bbb3f78994c90bd",
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // ==========================================================
    // FUNCI√ìN PARA GUARDAR EL PLAN LOCAL Y EN FIRESTORE
    // ==========================================================
    async function elegirPlan(plan) {

      const usuarioLogueado = JSON.parse(localStorage.getItem("usuarioLogueado") || "{}");

      if (!usuarioLogueado.correo) {
        alert("Debes iniciar sesi√≥n para elegir un plan.");
        return;
      }

      const userRef = doc(db, "usuarios", usuarioLogueado.correo);
      const negociosRef = collection(db, "usuarios", usuarioLogueado.correo, "negocios");
      const negociosSnap = await getDocs(negociosRef);
      const cantidadNegocios = negociosSnap.size;

      // ===============================
      // üî• L√çMITES POR PLAN
      // ===============================
      let limite = 1;
      if (plan === "plus") limite = 2;
      if (plan === "premium") limite = 3;

      // ===============================
      // üìå OBTENER PLAN ACTUAL REAL
      // ===============================
      let planActual = localStorage.getItem("planSeleccionado") || null;

      // Si no hay plan guardado a√∫n, permitir elegir cualquier plan
      if (!planActual) planActual = "ninguno";

      const nivel = { ninguno: 0, basico: 1, plus: 2, premium: 3 };

      // ===============================
      // üö´ NO PERMITIR BAJAR DE PLAN (solo si ya ten√≠a un plan)
      // ===============================
      if (planActual !== "ninguno" && nivel[plan] < nivel[planActual]) {
        alert(`No puedes bajar de nivel.\nTu plan actual es: ${planActual.toUpperCase()}`);
        return;
      }

      // ===============================
      // üö´ PLAN B√ÅSICO NO PERMITIDO SI YA TIENE 1 NEGOCIO O M√ÅS
      // ===============================
      if (plan === "basico" && cantidadNegocios >= 1) {
        alert("Ya tienes 1 negocio registrado.\nEl plan B√°sico ya no est√° disponible.\nPor favor selecciona Plus o Premium.");
        return;
      }

      // ===============================
      // üö´ NO PERMITIR ELEGIR UN PLAN QUE TENGA MENOR CAPACIDAD
      // ===============================
      if (cantidadNegocios > limite) {
        alert(
          `No puedes elegir este plan.\n` +
          `Este plan permite ${limite} negocios, ` +
          `pero ya tienes ${cantidadNegocios}.`
        );
        return;
      }

      // ===============================
      // üî• GUARDAR PLAN EN LOCAL Y FIRESTORE
      // ===============================
      localStorage.setItem("planSeleccionado", plan);

      if (plan === "basico") localStorage.setItem("planTexto", "B√°sico");
      if (plan === "plus") localStorage.setItem("planTexto", "Plus");
      if (plan === "premium") localStorage.setItem("planTexto", "Premium");

      try {
        await updateDoc(userRef, { plan: plan });
      } catch {
        await setDoc(userRef, { plan: plan });
      }

      // ===============================
      // üéØ REDIRECCI√ìN
      // ===============================
      window.location.href = "negoregistro.html";
    }

    window.elegirPlan = elegirPlan;

    // ==========================================================
    // DESACTIVAR BOTONES SEG√öN EL PLAN ACTUAL Y NEGOCIOS
    // ==========================================================
    // ==========================================================
    // DESACTIVAR BOTONES SEG√öN EL PLAN ACTUAL Y NEGOCIOS
    // ==========================================================
    async function actualizarUIPlanes() {
      const usuarioLogueado = JSON.parse(localStorage.getItem("usuarioLogueado") || "{}");

      if (!usuarioLogueado.correo) return;

      const negociosRef = collection(db, "usuarios", usuarioLogueado.correo, "negocios");
      const negociosSnap = await getDocs(negociosRef);
      const cantidadNegocios = negociosSnap.size;

      const planActual = localStorage.getItem("planSeleccionado") || "ninguno";

      const limites = { basico: 1, plus: 2, premium: 3 };

      // üî• Ciclo para los 3 planes
      ["basico", "plus", "premium"].forEach(plan => {
        const card = document.querySelector(`.${plan} .btn-seleccionar`);
        const planBox = document.querySelector(`.${plan}`);

        if (!card || !planBox) return;

        // Restaurar estilos por si acaso
        card.style.pointerEvents = "auto";
        card.style.background = "";
        planBox.style.opacity = "1";

        // ==========================
        // SI ES EL PLAN ACTUAL ‚Üí DESACTIVAR Y MARCAR
        // ==========================
        if (plan === planActual) {
          const registroCompleto = localStorage.getItem("registroCompleto") === "true";

          if (registroCompleto) {
            // üî¥ REGISTRO TERMINADO ‚Üí NO PUEDE CAMBIAR ESTE PLAN
            card.textContent = "PLAN SELECCIONADO";
            card.style.background = "#9e9e9e";
            card.style.pointerEvents = "none";
            planBox.style.opacity = "0.6";
          } else {
            // üü¢ EN REGISTRO ‚Üí PUEDE EDITAR/ CAMBIAR
            card.textContent = "PLAN SELECCIONADO (SEGUIR EDITANDO)";
            card.style.background = "#4caf50";
            card.style.pointerEvents = "auto"; // ‚úî puede pulsarlo
            planBox.style.opacity = "1";
          }

          return;
        }


        const registroCompleto = localStorage.getItem("registroCompleto") === "true";

        if (registroCompleto) {
          // Si ya termin√≥, bloquear planes inferiores o iguales
          if (nivel[plan] <= nivel[planActual]) {
            card.textContent = nivel[plan] === nivel[planActual]
              ? "PLAN SELECCIONADO"
              : "NO DISPONIBLE";

            card.style.background = "#9e9e9e";
            card.style.pointerEvents = "none";
            planBox.style.opacity = "0.6";
          }
        }





        // ==========================
        // SI EL PLAN NO ALCANZA PARA SUS NEGOCIOS ‚Üí BLOQUEO VISUAL
        // ==========================
        if (cantidadNegocios > limites[plan]) {
          card.textContent = "NO DISPONIBLE";
          card.style.background = "#cfcfcf";
          card.style.pointerEvents = "none";
          planBox.style.opacity = "0.5";
          return;
        }

        // ==========================
        // SI ES PLAN B√ÅSICO Y YA TIENE UN NEGOCIO ‚Üí BLOQUEAR
        // ==========================
        if (plan === "basico" && cantidadNegocios >= 1) {
          card.textContent = "NO DISPONIBLE";
          card.style.background = "#cfcfcf";
          card.style.pointerEvents = "none";
          planBox.style.opacity = "0.5";
          return;
        }
      });
    }

    // Ejecutar UI al cargar la p√°gina
    actualizarUIPlanes();
    window.actualizarUIPlanes = actualizarUIPlanes;


    document.addEventListener("click", (e) => {
      if (e.target.textContent.includes("SEGUIR EDITANDO")) {
        // Recuperar √∫ltimo negocio que el usuario estuvo editando
        const negocioId = localStorage.getItem("negocioEnEdicion");

        if (negocioId) {
          console.log("Volviendo a editar negocio:", negocioId);
          window.location.href = "negoregistro.html";
        } else {
          console.warn("‚ö† No se encontr√≥ negocioEnEdicion");
        }
      }
    });


  </script>

</body>

</html>